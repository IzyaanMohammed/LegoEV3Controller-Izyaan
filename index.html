<!DOCTYPE html>
<html>
<head>
    <title>T10 COMMANDER EV3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #111; color: #0f0; font-family: monospace; text-align: center; }
        #log { height: 120px; overflow-y: scroll; background: #000; padding: 10px; font-size: 11px; }
        .btn { margin: 10px; padding: 20px 40px; background: #222; border: 2px solid #0f0; font-size: 24px; }
        .btn:active { background: #0f0; color: #000; }
    </style>
</head>
<body>

<div id="log">DEBUG LOG</div>
<button onclick="connect()">CONNECT</button>

<div>
    <button class="btn" onpointerdown="move(60,60)" onpointerup="stop()">↑</button><br>
    <button class="btn" onpointerdown="move(-60,60)" onpointerup="stop()">←</button>
    <button class="btn" onpointerdown="move(60,-60)" onpointerup="stop()">→</button><br>
    <button class="btn" onpointerdown="move(-60,-60)" onpointerup="stop()">↓</button>
</div>

<script>
let port, writer, msgCount = 0;

function debug(msg) {
    const l = document.getElementById("log");
    l.innerHTML += msg + "\n";
    l.scrollTop = l.scrollHeight;
}

function toHex(bytes) {
    return Array.from(bytes).map(b => b.toString(16).padStart(2, "0")).join(" ");
}

async function connect() {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        writer = port.writable.getWriter();
        debug("Connected @115200");
    } catch(e) {
        debug("CONNECT ERROR: " + e.message);
    }
}

function buildDirectCommand(ops) {
    const length = ops.length + 5; // 5 bytes for counter,type,vars
    const buf = new Uint8Array(2 + 2 + 1 + 2 + ops.length);

    let offset = 0;
    buf[offset++] = length & 0xff;
    buf[offset++] = (length >> 8) & 0xff;

    buf[offset++] = msgCount & 0xff;
    buf[offset++] = (msgCount >> 8) & 0xff;

    buf[offset++] = 0x80; // no reply
    buf[offset++] = 0x00; // local/global vars = 0
    buf[offset++] = 0x00;

    buf.set(ops, offset);
    return buf;
}

async function sendOps(ops) {
    if (!writer) return;
    msgCount++;
    const cmd = buildDirectCommand(ops);
    debug("Sending: " + toHex(cmd));
    await writer.write(cmd);
}

function lc0(val) {
    return val & 0xff; // one byte literal constant
}

async function move(l, r) {
    // EV3 opcodes require message format: opOUTPUT_POWER, LC0(LAYER), LC0(PORT BITMASK), LC0(PWR)
    const ops = new Uint8Array([
        0xA4, lc0(0), lc0(1), lc0(r),      // OUTPUT_POWER layer0, portA, power
        0xA4, lc0(0), lc0(8), lc0(l),      // OUTPUT_POWER layer0, portD, power
        0xA6, lc0(0), lc0(9)               // OUTPUT_START layer0, ports A+D
    ]);
    await sendOps(ops);
}

async function stop() {
    const ops = new Uint8Array([
        0xA3, lc0(0), lc0(9), lc0(1)        // OUTPUT_STOP layer0, A+D, brake
    ]);
    await sendOps(ops);
}
</script>

</body>
</html>
