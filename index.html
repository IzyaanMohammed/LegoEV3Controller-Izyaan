<!DOCTYPE html>
<html>
<head>
    <title>T10 COMMANDER</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <style>
        body {
            margin: 0;
            background: #111;
            color: #0f0;
            font-family: monospace;
            text-align: center;
        }

        #log {
            height: 90px;
            background: #000;
            border-bottom: 2px solid #333;
            overflow-y: auto;
            padding: 10px;
            font-size: 11px;
            text-align: left;
        }

        #conn {
            width: 90%;
            padding: 18px;
            margin: 15px;
            background: #005eff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 300px;
            margin: 30px auto;
            gap: 15px;
        }

        .btn {
            height: 85px;
            border-radius: 20px;
            background: #222;
            border: 2px solid #0f0;
            color: #0f0;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: none;
        }

        .btn:active {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 18px #0f0;
        }
    </style>
</head>

<body>

<div id="log">T10 DEBUG: waiting for EV3...</div>
<button id="conn" onclick="connect()">CONNECT TO T10</button>

<div class="grid">
    <div></div>
    <div class="btn" onpointerdown="move(60, 60)" onpointerup="stop()">↑</div>
    <div></div>

    <div class="btn" onpointerdown="move(-50, 50)" onpointerup="stop()">←</div>
    <div class="btn" onpointerdown="move(-60, -60)" onpointerup="stop()">↓</div>
    <div class="btn" onpointerdown="move(50, -50)" onpointerup="stop()">→</div>
</div>

<script>
let port;
let writer;
let msgCount = 0;

function debug(msg) {
    const log = document.getElementById("log");
    log.innerHTML += "> " + msg + "<br>";
    log.scrollTop = log.scrollHeight;
}

async function connect() {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();

        document.getElementById("conn").style.background = "#28a745";
        document.getElementById("conn").innerText = "T10 ONLINE";
        debug("CONNECTED TO EV3");
    } catch (e) {
        debug("ERROR: " + e.message);
    }
}

async function move(left, right) {
    if (!writer) return;
    msgCount++;

    const packet = new Int8Array([
        0x0E, 0x00,              // Packet length (14 bytes)
        msgCount & 0xFF, 0x00,   // Message counter
        0x80,                    // Direct command, no reply
        0x00, 0x00,              // Memory
        0xA4, 0x00, 0x01, right, // Output_Power: Port A
        0xA4, 0x00, 0x08, left,  // Output_Power: Port D
        0xA6, 0x00, 0x09         // Output_Start: A + D
    ]);

    await writer.write(packet);
    debug("MOVE A=" + right + " D=" + left);
}

async function stop() {
    if (!writer) return;
    msgCount++;

    const packet = new Uint8Array([
        0x09, 0x00,
        msgCount & 0xFF, 0x00,
        0x80, 0x00, 0x00,
        0xA3, 0x00, 0x09, 0x01 // Stop A+D with brake
    ]);

    await writer.write(packet);
    debug("STOP");
}
</script>

</body>
</html>
