<!DOCTYPE html>
<html>
<head>
    <title>EV3 A+D Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { text-align: center; font-family: sans-serif; background: #222; color: white; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 300px; margin: auto; }
        button { width: 90px; height: 90px; font-size: 16px; font-weight: bold; border-radius: 10px; border: none; background: #444; color: white; touch-action: manipulation; }
        button:active { background: #00ff00; color: black; }
        #conn { background: #007bff; width: 200px; height: 50px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>EV3 A+D Remote</h1>
    <button id="conn" onclick="connect()">CONNECT TO EV3</button>

    <div class="grid">
        <div></div><button onpointerdown="move(50,50)" onpointerup="stop()">FWD</button><div></div>
        <button onpointerdown="move(-40,40)" onpointerup="stop()">LEFT</button>
        <button onpointerdown="move(-50,-50)" onpointerup="stop()">BACK</button>
        <button onpointerdown="move(40,-40)" onpointerup="stop()">RIGHT</button>
    </div>

    <script>
        let port, writer;

        async function connect() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                writer = port.writable.getWriter();
                document.getElementById('conn').innerText = "CONNECTED";
                document.getElementById('conn').style.background = "#28a745";
            } catch (e) { alert("Use Chrome (Android) or Bluefy (iOS)"); }
        }

        async function move(leftSpeed, rightSpeed) {
            if (!writer) return;
            // Port A = 0x01, Port D = 0x08. Both A+D = 0x09
            const l = leftSpeed & 0xFF;
            const r = rightSpeed & 0xFF;
            
            // Direct Command: OutputSpeed on Ports A (0x01) and D (0x08)
            const cmd = new Uint8Array([
                0x0F, 0x00, // Length
                0x00, 0x00, // Msg Counter
                0x80,       // No Reply
                0x00, 0x00, // Local/Global mem
                0xA2, 0x00, 0x01, 0x81, r, // Set Speed Motor A
                0xA2, 0x00, 0x08, 0x81, l, // Set Speed Motor D
                0xA6, 0x00, 0x09            // Start Motors A+D
            ]);
            await writer.write(cmd);
        }

        async function stop() {
            if (!writer) return;
            const cmd = new Uint8Array([0x09, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0xA3, 0x00, 0x09, 0x01]);
            await writer.write(cmd);
        }
    </script>
</body>
</html>
